<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.warmheart.workerunion.server.dao.SettlementItemMapper">
  <resultMap id="BaseResultMap" type="top.warmheart.workerunion.server.model.SettlementItem">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="company_id" jdbcType="BIGINT" property="companyId" />
    <result column="project_id" jdbcType="BIGINT" property="projectId" />
    <result column="purchase_item_id" jdbcType="BIGINT" property="purchaseItemId" />
    <result column="purchase_item_name" jdbcType="VARCHAR" property="purchaseItemName" />
    <result column="resource_implement_item_id" jdbcType="BIGINT" property="resourceImplementItemId" />
    <result column="subcontractor_id" jdbcType="BIGINT" property="subcontractorId" />
    <result column="subcontractor_name" jdbcType="VARCHAR" property="subcontractorName" />
    <result column="year" jdbcType="INTEGER" property="year" />
    <result column="month" jdbcType="INTEGER" property="month" />
    <result column="money" jdbcType="DECIMAL" property="money" />
    <result column="cst_create" jdbcType="TIMESTAMP" property="cstCreate" />
    <result column="cst_modified" jdbcType="TIMESTAMP" property="cstModified" />
  </resultMap>
  <resultMap id="SettlementItemDtoMap" type="top.warmheart.workerunion.server.dto.SettlementItemDto">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="company_id" jdbcType="BIGINT" property="companyId" />
    <result column="project_id" jdbcType="BIGINT" property="projectId" />
    <result column="purchase_item_id" jdbcType="BIGINT" property="purchaseItemId" />
    <result column="purchase_item_name" jdbcType="VARCHAR" property="purchaseItemName" />
    <result column="resource_implement_item_id" jdbcType="BIGINT" property="resourceImplementItemId" />
    <result column="subcontractor_id" jdbcType="BIGINT" property="subcontractorId" />
    <result column="subcontractor_name" jdbcType="VARCHAR" property="subcontractorName" />
    <result column="year" jdbcType="INTEGER" property="year" />
    <result column="month" jdbcType="INTEGER" property="month" />
    <result column="money" jdbcType="DECIMAL" property="money" />
    <result column="cst_create" jdbcType="TIMESTAMP" property="cstCreate" />
    <result column="cst_modified" jdbcType="TIMESTAMP" property="cstModified" />
    <result column="sum_money" jdbcType="DECIMAL" property="sumMoney" />
    <result column="resource_implement_item_name" jdbcType="VARCHAR" property="resourceImplementItemName" />
  	<result column="resource_implement_item_money" jdbcType="DECIMAL" property="resourceImplementItemMoney" />
  </resultMap>
  <resultMap id="SettlementItem2DtoMap" type="top.warmheart.workerunion.server.dto.SettlementItem2Dto">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="company_id" jdbcType="BIGINT" property="companyId" />
    <result column="project_id" jdbcType="BIGINT" property="projectId" />
    <result column="purchase_item_id" jdbcType="BIGINT" property="purchaseItemId" />
    <result column="purchase_item_name" jdbcType="VARCHAR" property="purchaseItemName" />
    <result column="resource_implement_item_id" jdbcType="BIGINT" property="resourceImplementItemId" />
    <result column="subcontractor_id" jdbcType="BIGINT" property="subcontractorId" />
    <result column="subcontractor_name" jdbcType="VARCHAR" property="subcontractorName" />
    <result column="year" jdbcType="INTEGER" property="year" />
    <result column="month" jdbcType="INTEGER" property="month" />
    <result column="money" jdbcType="DECIMAL" property="money" />
    <result column="cst_create" jdbcType="TIMESTAMP" property="cstCreate" />
    <result column="cst_modified" jdbcType="TIMESTAMP" property="cstModified" />
    <result column="resource_implement_item_name" jdbcType="VARCHAR" property="resourceImplementItemName" />
  	<result column="resource_implement_item_money" jdbcType="DECIMAL" property="resourceImplementItemMoney" />
  </resultMap>
  <delete id="deleteByPrimaryKey" parameterType="java.math.BigInteger">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from settlement_item
    where id = #{id,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="top.warmheart.workerunion.server.model.SettlementItem">
    <selectKey keyProperty="id" order="AFTER" resultType="java.math.BigInteger">
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into settlement_item (company_id, project_id, resource_implement_item_id, 
      subcontractor_id, subcontractor_name, year, 
      month, money, cst_create, 
      cst_modified, purchase_item_id, 
      purchase_item_name)
    values (#{companyId,jdbcType=BIGINT}, #{projectId,jdbcType=BIGINT}, #{resourceImplementItemId,jdbcType=BIGINT}, 
      #{subcontractorId,jdbcType=BIGINT}, #{subcontractorName,jdbcType=VARCHAR}, #{year,jdbcType=INTEGER}, 
      #{month,jdbcType=INTEGER}, #{money,jdbcType=DECIMAL}, now(), 
      now(), #{purchaseItemId,jdbcType=BIGINT}, 
      #{purchaseItemName,jdbcType=VARCHAR})
  </insert>
  <update id="updateByPrimaryKey" parameterType="top.warmheart.workerunion.server.model.SettlementItem">
    update settlement_item
    set company_id = #{companyId,jdbcType=BIGINT},
      project_id = #{projectId,jdbcType=BIGINT},
      purchase_item_id = #{purchaseItemId,jdbcType=BIGINT},
      purchase_item_name = #{purchaseItemName,jdbcType=VARCHAR},
      resource_implement_item_id = #{resourceImplementItemId,jdbcType=BIGINT},
      subcontractor_id = #{subcontractorId,jdbcType=BIGINT},
      subcontractor_name = #{subcontractorName,jdbcType=VARCHAR},
      year = #{year,jdbcType=INTEGER},
      month = #{month,jdbcType=INTEGER},
      money = #{money,jdbcType=DECIMAL},
      cst_modified = now()
    where id = #{id,jdbcType=BIGINT}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.math.BigInteger" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select id, company_id, project_id, resource_implement_item_id, subcontractor_id, 
    subcontractor_name, year, month, money, cst_create, cst_modified, purchase_item_id, purchase_item_name
    from settlement_item
    where id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectDetailById" parameterType="java.math.BigInteger" resultMap="SettlementItem2DtoMap">
    select a.id, a.company_id, a.project_id, a.resource_implement_item_id, a.subcontractor_id, 
    a.subcontractor_name, a.year, a.month, a.money, a.cst_create, a.cst_modified, a.purchase_item_id, a.purchase_item_name, r.name as resource_implement_item_name, r.money as resource_implement_item_money
    from settlement_item as a join resource_implement_item r on a.resource_implement_item_id=r.id 
    where a.id = #{id,jdbcType=BIGINT}
  </select>
  <select id="selectAll" resultMap="BaseResultMap">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select id, company_id, project_id, resource_implement_item_id, subcontractor_id, 
    subcontractor_name, year, month, money, cst_create, cst_modified, purchase_item_id, purchase_item_name
    from settlement_item
  </select>
  <select id="countByProjectId" resultType="java.lang.Integer">
		select count(distinct id)
		from settlement_item where
		project_id=#{projectId,jdbcType=BIGINT}
	</select>
  <select id="pageByProjectId" resultMap="SettlementItemDtoMap">
    select a.id, a.company_id, a.project_id, a.resource_implement_item_id, a.subcontractor_id, 
    a.subcontractor_name, a.year, a.month, a.money, a.cst_create, a.cst_modified, a.purchase_item_id, a.purchase_item_name, sum(ifnull(b.money,0))as sum_money, r.name as resource_implement_item_name, r.money as resource_implement_item_money
    from settlement_item as a join resource_implement_item r on a.resource_implement_item_id=r.id left join settlement_item as b on (b.year*12+b.month)&lt;=(a.year*12+a.month)
		and a.project_id=b.project_id and a.resource_implement_item_id=b.resource_implement_item_id where 
		a.project_id=#{projectId,jdbcType=BIGINT}  group by a.id
		order
		by a.year desc, a.month desc limit
		#{page.frontIndex},#{page.size}
  </select>
  <select id="selectListByResourceImplementItemId" resultMap="BaseResultMap">
    select id, company_id, project_id, resource_implement_item_id, subcontractor_id, 
    subcontractor_name, year, month, money, cst_create, cst_modified, purchase_item_id, purchase_item_name
    from settlement_item where resource_implement_item_id = #{resourceImplementItemId,jdbcType=BIGINT}
  </select>
   <select id="selectByResourceImplementYearMonth" resultMap="BaseResultMap">
    select id, company_id, project_id, resource_implement_item_id, subcontractor_id, 
    subcontractor_name, year, month, money, cst_create, cst_modified, purchase_item_id, purchase_item_name
    from settlement_item where resource_implement_item_id = #{resourceImplementItemId,jdbcType=BIGINT} and year=#{year,jdbcType=INTEGER} and month=#{month,jdbcType=INTEGER}
  </select>
  
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.warmheart.workerunion.server.dao.SubcontractorMapper">
	<resultMap id="BaseResultMap" type="top.warmheart.workerunion.server.model.Subcontractor">
		<!-- WARNING - @mbg.generated This element is automatically generated by MyBatis Generator, do not modify. -->
		<id column="id" jdbcType="BIGINT" property="id" />
		<result column="company_id" jdbcType="BIGINT" property="companyId" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="num" jdbcType="VARCHAR" property="num" />
		<result column="subcontractor_grade_id" jdbcType="BIGINT" property="subcontractorGradeId" />
		<result column="subcontractor_grade_name" jdbcType="VARCHAR" property="subcontractorGradeName" />
		<result column="valid_date" jdbcType="TIMESTAMP" property="validDate" />
		<result column="contact_person" jdbcType="VARCHAR" property="contactPerson" />
		<result column="contact_phone" jdbcType="VARCHAR" property="contactPhone" />
		<result column="cst_create" jdbcType="TIMESTAMP" property="cstCreate" />
		<result column="cst_modified" jdbcType="TIMESTAMP" property="cstModified" />
		<result column="is_del" jdbcType="BIT" property="del" />
	</resultMap>
	<resultMap id="SubcontractorDtoMap" type="top.warmheart.workerunion.server.dto.SubcontractorDto">
		<id column="id" jdbcType="BIGINT" property="id" />
		<result column="company_id" jdbcType="BIGINT" property="companyId" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="num" jdbcType="VARCHAR" property="num" />
		<result column="subcontractor_grade_id" jdbcType="BIGINT" property="subcontractorGradeId" />
		<result column="subcontractor_grade_name" jdbcType="VARCHAR" property="subcontractorGradeName" />
		<result column="subcontractor_qualification_id" jdbcType="VARCHAR" property="subcontractorQualificationId" />
		<result column="subcontractor_qualification_name" jdbcType="VARCHAR" property="subcontractorQualificationName" />
		<result column="valid_date" jdbcType="TIMESTAMP" property="validDate" />
		<result column="contact_person" jdbcType="VARCHAR" property="contactPerson" />
		<result column="contact_phone" jdbcType="VARCHAR" property="contactPhone" />
		<result column="cst_create" jdbcType="TIMESTAMP" property="cstCreate" />
		<result column="cst_modified" jdbcType="TIMESTAMP" property="cstModified" />
		<result column="is_del" jdbcType="BIT" property="del" />
	</resultMap>
	<delete id="deleteByPrimaryKey" parameterType="java.math.BigInteger">
		<!-- WARNING - @mbg.generated This element is automatically generated by MyBatis Generator, do not modify. -->
		delete from subcontractor
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert id="insert" parameterType="top.warmheart.workerunion.server.model.Subcontractor">
		<!-- WARNING - @mbg.generated This element is automatically generated by MyBatis Generator, do not modify. -->
		<selectKey keyProperty="id" order="AFTER" resultType="java.math.BigInteger">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into subcontractor (company_id, name, num,
		subcontractor_grade_id, subcontractor_grade_name,
		valid_date,
		contact_person, contact_phone,
		cst_create, cst_modified, is_del
		)
		values (#{companyId,jdbcType=BIGINT},
		#{name,jdbcType=VARCHAR}, #{num,jdbcType=VARCHAR},
		#{subcontractorGradeId,jdbcType=BIGINT},
		#{subcontractorGradeName,jdbcType=VARCHAR},
		#{validDate,jdbcType=INTEGER}, #{contactPerson,jdbcType=VARCHAR},
		#{contactPhone,jdbcType=VARCHAR},
		now(), now(), false
		)
	</insert>
	<update id="updateByPrimaryKey" parameterType="top.warmheart.workerunion.server.model.Subcontractor">
		update subcontractor
		set company_id = #{companyId,jdbcType=BIGINT},
		name = #{name,jdbcType=VARCHAR},
		num = #{num,jdbcType=VARCHAR},
		subcontractor_grade_id =
		#{subcontractorGradeId,jdbcType=BIGINT},
		subcontractor_grade_name = #{subcontractorGradeName,jdbcType=VARCHAR},
		valid_date = #{validDate,jdbcType=INTEGER},
		contact_person = #{contactPerson,jdbcType=VARCHAR},
		contact_phone =
		#{contactPhone,jdbcType=VARCHAR},
		cst_modified = now()
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="deleteById" parameterType="java.math.BigInteger">
		update subcontractor
		set
		cst_modified = now(),
		is_del = true
		where id =
		#{id,jdbcType=BIGINT} and is_del=false
	</update>
	<select id="selectByPrimaryKey" parameterType="java.math.BigInteger" resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by MyBatis Generator, do not modify. -->
		select id, company_id, name, num, subcontractor_grade_id, subcontractor_grade_name,
		valid_date, contact_person,
		contact_phone, cst_create, cst_modified, is_del
		from subcontractor
		where id = #{id,jdbcType=BIGINT}
	</select>
	<select id="selectByCompanyAndNum" resultMap="BaseResultMap">
		select id, company_id, name, num, subcontractor_grade_id,
		subcontractor_grade_name,
		valid_date, contact_person, contact_phone, cst_create, cst_modified, is_del
		from subcontractor
		where company_id=#{companyId,jdbcType=BIGINT} and num=#{num,jdbcType=VARCHAR}
	</select>
	<select id="selectListSimpleItemByCompanyId" resultMap="BaseResultMap">
		select id, company_id, name, num, subcontractor_grade_id,
		subcontractor_grade_name,
		valid_date, contact_person, contact_phone, cst_create, cst_modified, is_del
		from subcontractor
		where company_id=#{companyId,jdbcType=BIGINT} and is_del = false
	</select>
	<!-- 获取符合模糊搜索的分包商信息个数 -->
	<select id="countByFuzzy" resultType="java.lang.Integer">
		select count(distinct s.id) from subcontractor s
		<if test="subcontractorDto.subcontractorQualificationId != null">
			join subcontractor_has_subcontractor_qualification ssq on
			ssq.subcontractor_id= s.id and ssq.subcontractor_qualification_id = #{subcontractorDto.subcontractorQualificationId}
		</if>
		where
		s.company_id=#{subcontractorDto.companyId} and s.is_del=false
		<if test="subcontractorDto.num != null and subcontractorDto.num != ''">
			and s.num like CONCAT('%',#{subcontractorDto.num},'%')
		</if>
		<if test="subcontractorDto.name != null and subcontractorDto.name != ''">
			and s.name like CONCAT('%',#{subcontractorDto.name},'%')
		</if>
		<if test="subcontractorDto.validDate != null">
			and s.valid_date &lt;= #{subcontractorDto.validDate}
		</if>
	</select>

	<!-- 获取符合模糊搜索的分包商信息列表 -->
	<select id="pageByFuzzy" resultMap="SubcontractorDtoMap">
		select s.id, s.company_id, s.name, s.num, s.subcontractor_grade_id, s.subcontractor_grade_name, s.valid_date,
		s.contact_person, s.contact_phone, s.cst_create, s.cst_modified, s.is_del, ifnull(group_concat(distinct sq.name),"") as
		subcontractor_qualification_name
		from subcontractor s left join subcontractor_has_subcontractor_qualification ssq on
		ssq.subcontractor_id= s.id left join
		subcontractor_qualification sq on sq.id=ssq.subcontractor_qualification_id,
		(select distinct s2.id from subcontractor s2
		<if test="subcontractorDto.subcontractorQualificationId != null">
			join subcontractor_has_subcontractor_qualification ssq2 on
			ssq2.subcontractor_id= s2.id and ssq2.subcontractor_qualification_id = #{subcontractorDto.subcontractorQualificationId}
		</if>
		where
		s2.company_id=#{subcontractorDto.companyId} and s2.is_del=false
		<if test="subcontractorDto.num != null and subcontractorDto.num != ''">
			and s2.num like CONCAT('%',#{subcontractorDto.num},'%')
		</if>
		<if test="subcontractorDto.name != null and subcontractorDto.name != ''">
			and s2.name like CONCAT('%',#{subcontractorDto.name},'%')
		</if>
		<if test="subcontractorDto.validDate != null">
			and s2.valid_date &lt;= #{subcontractorDto.validDate}
		</if>
		group by s2.id order by s2.num asc limit #{page.frontIndex},#{page.size})temp where s.id=temp.id group by s.id order
		by s.num asc
	</select>


</mapper>